---
title: "p1875 db10 / WU160118 / R444589 -	postprocessing / summary"
author: 
- name: Christian Panse
  affiliation: FGCZ
  email: cp@fgcz.ethz.ch
- name: Bernd Roschitzki
  affiliation: FGCZ
package: NestLink
output:
  BiocStyle::html_document2
abstract: |
  Description of your vignette
vignette: |
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{NestLink - p1875 db10 / WU160118 -	postprocessing / summary}
date: '2017-11-02, 2017-11-03, 2017-11-04, 2017-11-06, 2017-11-08, 2018-01-30'
---


  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Download data from http://fgcz-bfabric.uzh.ch

- Go through from http://fgcz-bfabric.uzh.ch
- search for [workunit id 160118](https://fgcz-bfabric.uzh.ch/bfabric/userlab/show-workunit.html?id=160118)
- Download the [resource with id 444589](https://fgcz-bfabric.uzh.ch/bfabric/userlab/show-resource.html?id=444589)
- The following code snippet is only extracting the meta data (no MS2)

```{r eval=FALSE}
load("~/Downloads/444589.RData")
library(protViz)
WU160118 <- do.call('rbind', lapply(list("F255737", "F255744", "F255747", 
  "F255749", "F255751", "F255760", "F255761", "F255762"), 
  function(datfilename){
      df <- as.data.frame.mascot(get(datfilename))
      df$datfilename <- datfilename
      df
    }
  ))
save(WU160118, file = "../inst/extdata/WU160118.RData", 
     compress = TRUE, compression_level = 9)   
```

# Load requiered R packages

```{r message=FALSE}
library(NestLink)
```

# Charge state frequency

## Load workunit(WU): 160118 - mascot2RData bfabric application

```{r}
load(system.file("extdata/WU160118.RData", package = "NestLink"))
WU <- WU160118
```

## Filtering
```{r}
PATTERN <- "^GS[ASTNQDEFVLYWGP]{7}(WR|WLTVR|WQEGGR|WLR|WQSR)$"
idx <- grepl(PATTERN, WU$pep_seq)
WU <- WU[idx & WU$pep_score > 25,]
```


## Charge State Frequency

counting
```{r}
# WU.pep_seq <- WU$pep_seq # TODO remove?
WU$chargeInt <- as.integer(substr(WU$query_charge, 0, 1))
table(WU$chargeInt)
```

in percent
```{r}
round(100 * (table(WU$chargeInt) / nrow(WU)),1)
```

as histograms 
```{r fig.retina=3, fig.height=8}
ggplot(WU, aes(x = moverz * chargeInt, fill = (query_charge), colour = (query_charge))) +
    facet_wrap(~ datfilename, ncol = 2) +
    geom_histogram(binwidth= 10, alpha=.3, position="identity") +
    labs(title = "Precursor mass to charge frequency plot",
      subtitle = "Plotting frequency of precursor masses for each charge state",
      x = "Precursor mass [neutral mass]", 
      y = "Frequency [counts]",
      fill = "Charge State",
      colour = "Charge State") +
    scale_x_continuous(breaks = scales::pretty_breaks(8)) +
    theme_light()
```

Pascal E.: ``We confirmed this assumption also for the gas-phase by blabla-analysis and found that 99.9-percent of flycode precursor ions correspond to doubly charge species (data not shown). The omission of positively charged residues is also critical in order to render trypsin a site-specific protease (removal of His-tag, see previous paragraph).''


## AddOns
```{r}
WU$sufix <- substr(WU$pep_seq, 10, 100)

ggplot(WU, aes(x = moverz * chargeInt, fill = sufix, colour = sufix)) +
    geom_histogram(binwidth= 10, alpha=.2, position="identity") +
    #facet_wrap(~ substr(pep_seq, 10, 100)) +
   theme_light()
```

```{r}
ggplot(WU, aes(x = moverz * chargeInt, fill = sufix)) +
    geom_histogram(binwidth= 10, alpha=.9, position="identity") +
    facet_wrap(~ substr(pep_seq, 10, 100)) +
   theme_light()
```

```{r}
ggplot(WU, aes(x = pep_score, fill = query_charge, colour = query_charge)) +
    geom_histogram(binwidth= 2, alpha=.5, position="identity") +
    facet_wrap(~ substr(pep_seq, 10, 100)) +
   theme_light()
```

# Compare real and in-silico flycodes

read the flycodes from p1875 db10 fasta file

```{r}
FC <- read.table(system.file("extdata/FC.tryptic", package = "NestLink"), header = TRUE)
FC$peptide <- (as.character(FC$peptide))
idx <- grep (PATTERN, FC$peptide)

FC$cond <- "FC"
FC$pim <- parentIonMass(FC$peptide)
FC <- FC[nchar(FC$peptide) >2, ]
FC$ssrc <- sapply(FC$peptide, ssrc)
FC$peptideLength <- nchar(as.character(FC$peptide))
FC <- FC[idx,]
head(FC)    
```

## AA design frequency

```
A 	18.0
S 	6.0
T 	12.0
N 	1.0
Q 	1.0
D 	11.0
E 	11.0
V 	12.0
L 	2.0
F 	1.0
Y 	4.0
W 	1.0
G 	8.0
P 	12.0
```

```{r}
aa_pool_x7 <- c(rep('A', 18), rep('S', 6), rep('T', 12), rep('N', 1), rep('Q', 1), rep('D', 11), 
              rep('E', 11), rep('V', 12), rep('L', 2), rep('F', 1), rep('Y', 4), rep('W', 1), 
              rep('G', 8), rep('P', 12))

aa_pool_x7.post <- c(rep('WR', 20), rep('WLTVR'), rep('WQEGGR', 20), rep('WLR', 20), rep('WQSR', 20))

```

```{r}
FC.pep_seq.freq <- table(unlist(strsplit(substr(FC$peptide, 3, 9), "")))
FC.freq <- round(FC.pep_seq.freq / sum(FC.pep_seq.freq) * 100)


FC.pep_seq.freq.post <- table(unlist((substr(FC$peptide, 10, 100))))
FC.freq.post <- round(FC.pep_seq.freq.post / sum(FC.pep_seq.freq.post) * 100)


WU.pep_seq.freq <- table(unlist(strsplit(substr(WU$pep_seq, 3, 9), "")))
WU.freq <- round(WU.pep_seq.freq / sum(WU.pep_seq.freq) * 100)


WU.pep_seq.freq.post <- table(unlist(substr(WU$pep_seq, 10, 100)))
WU.freq.post <- round(WU.pep_seq.freq.post / sum(WU.pep_seq.freq.post) *100)
```

```{r}
table(aa_pool_x7)
FC.freq
WU.freq
```


```{r}
AAfreq1 <- data.frame(aa = table(aa_pool_x7))
names(AAfreq1) <- c('AA', 'freq')
AAfreq1$cond <- 'aa_pool_x7'

AAfreq2 <- data.frame(aa=FC.freq)
names(AAfreq2) <- c('AA', 'freq')
AAfreq2$cond <- "db10.fasta"

AAfreq3 <- data.frame(aa=WU.freq)
names(AAfreq3) <- c('AA', 'freq')
AAfreq3$cond <- "WU"

AAfreq <- do.call('rbind', list(AAfreq1, AAfreq2, AAfreq3))
```

```{r}
AAfreq1.post <- data.frame(aa=table(aa_pool_x7.post))
names(AAfreq1.post) <- c('AA', 'freq')
AAfreq1.post$cond <- "aa_pool_x7"

AAfreq2.post <- data.frame(aa=FC.freq.post)
names(AAfreq2.post) <- c('AA', 'freq')
AAfreq2.post$cond <- "db10.fasta"

AAfreq3.post <- data.frame(aa=WU.freq.post)
names(AAfreq3.post) <- c('AA', 'freq')
AAfreq3.post$cond <- "WU"

AAfreq.post <- do.call('rbind', list(AAfreq1.post, AAfreq2.post, AAfreq3.post))

```

```{r fig.retina=3}
ggplot(data=AAfreq, aes(x=AA, y=freq, fill=cond)) + 
  geom_bar(stat="identity", position="dodge") + 
  labs(title = "amino acid frequency plot") +
  theme_light()
```


```{r fig.retina=3}
ggplot(data=AAfreq.post, aes(x=AA, y=freq, fill=cond)) + 
  geom_bar(stat="identity", position="dodge") + 
  labs(title = "sufix frequency plot") +
  theme_light()
```

## ssrc calc

```{r fig.retina=3, fig.height=12}
WU$ssrc <- sapply(as.character(WU$pep_seq), ssrc)
WU$sufix <- substr(WU$pep_seq, 10,100)
ggplot(WU, aes(x = RTINSECONDS, y = ssrc)) +
  geom_point(aes(alpha=pep_score, colour = datfilename)) +
  facet_wrap(~ datfilename * sufix, ncol = 5, nrow = 8) +
  geom_smooth(method = 'lm') 
#+
#  stat_smooth_func(geom="text",method="lm",hjust=0,parse=TRUE) 
 
#plot(rt <- WU$RTINSECONDS, 
#     hy <- , 
#     pch=16, col=rgb(0.3, 0.3, 0.3, 0.1))
```
```{r}
cor(WU$RTINSECONDS, WU$ssrc, method = 'spearman')
#abline(lm(hy ~ rt))
```

 
